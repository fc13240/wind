!function(){"use strict";function e(){return µ.newAgent().on({reject:J.error,fail:J.error})}function t(e){var t=this.cancel;return J.status("Downloading..."),µ.loadJson(e).then(function(e){if(t.requested)return null;W.time("building meshes");var n=e.objects,a=topojson.feature(e,µ.isMobile()?n.coastline_tiny:n.coastline_110m),o=topojson.feature(e,µ.isMobile()?n.coastline_110m:n.coastline_50m),i=topojson.feature(e,µ.isMobile()?n.lakes_tiny:n.lakes_110m),r=topojson.feature(e,µ.isMobile()?n.lakes_110m:n.lakes_50m);return W.timeEnd("building meshes"),{coastLo:a,coastHi:o,lakesLo:i,lakesHi:r}})}function n(e){var t=globes.get(e);return t?when(t(U)):when.reject("Unknown projection: "+e)}function a(){J.status("Downloading..."),W.time("build grids");var e=this.cancel;ae++;var t=when.map(products.productsFor(K.attributes),function(t){return t.load(e)});return when.all(t).then(function(e){return W.time("build grids"),{primaryGrid:e[0],overlayGrid:e[1]||e[0]}}).ensure(function(){ae--})}function o(e){if(ae>0)return void W.debug("Download in progress--ignoring nav request.");var t=Z.value().primaryGrid.navigate(e);t&&K.save(µ.dateToConfig(t))}function i(e,t){function n(e,t){if((!ee.value()||ee.value().isInsideBoundary(e[0],e[1]))&&t&&_.isFinite(t[0])&&_.isFinite(t[1])){var n=d3.select(".location-mark");n.node()||(n=d3.select("#foreground").append("path").attr("class","location-mark")),n.datum({type:"Point",coordinates:t}).attr("d",i)}}function a(){d3.selectAll("path").attr("d",i),$.trigger("redraw"),c=_.throttle(a,s,{leading:!1})}if(!e||!t)return null;J.status("Rendering Globe..."),W.time("rendering map");var o=_.clone(Backbone.Events);$._previous&&$._previous.stopListening(),$._previous=o,µ.removeChildren(d3.select("#map").node()),µ.removeChildren(d3.select("#foreground").node()),t.defineMap(d3.select("#map"),d3.select("#foreground"));var i=d3.geo.path().projection(t.projection).pointRadius(7),r=d3.select(".coastline"),l=d3.select(".lakes");d3.selectAll("path").attr("d",i),oe.point&&oe.coord&&n(oe.point,oe.coord);var s=5,c=_.throttle(a,s,{leading:!1});return o.listenTo(Q,{moveStart:function(){r.datum(e.coastLo),l.datum(e.lakesLo),$.trigger("start")},move:function(){c()},moveEnd:function(){r.datum(e.coastHi),l.datum(e.lakesHi),d3.selectAll("path").attr("d",i),$.trigger("render")},click:n}),when(!0).then(function(){Q.globe(t)}),W.timeEnd("rendering map"),"ready"}function r(e){if(!e)return null;W.time("render mask");var t=U.width,n=U.height,a=d3.select(document.createElement("canvas")).attr("width",t).attr("height",n).node(),o=e.defineMask(a.getContext("2d"));o.fillStyle="rgba(255, 0, 0, 1)",o.fill();var i=o.getImageData(0,0,t,n),r=i.data;return W.timeEnd("render mask"),{imageData:i,isVisible:function(e,n){return r[4*(n*t+e)+3]>0},set:function(e,n,a){var o=4*(n*t+e);return r[o]=a[0],r[o+1]=a[1],r[o+2]=a[2],r[o+3]=a[3],this}}}function l(e,t,n){function a(t,n){var a=e[Math.round(t)];return a&&a[Math.round(n)]||H}return a.isDefined=function(e,t){return null!==a(e,t)[2]},a.isInsideBoundary=function(e,t){return a(e,t)!==H},a.release=function(){e=[]},a.randomize=function(e){var n,o,i=0;do{n=Math.round(_.random(t.x,t.xMax)),o=Math.round(_.random(t.y,t.yMax))}while(!a.isDefined(n,o)&&i++<30);return e.x=n,e.y=o,e},a.overlay=n.imageData,a}function s(e,t,n,a,o,i,r){var l=r[0]*i,s=r[1]*i,c=µ.distortion(e,t,n,a,o);return r[0]=c[0]*l+c[2]*s,r[1]=c[1]*l+c[3]*s,r}function c(e,t){function n(e){for(var t=[],n=f.y;n<=f.yMax;n+=2)if(a.isVisible(e,n)){h[0]=e,h[1]=n;var o=u.invert(h),i=O,r=null;if(o){var l=o[0],c=o[1];if(isFinite(l)){r=p(l,c);var d=null;r&&(r=s(u,l,c,e,n,v,r),d=r[2]),b&&(d=y(l,c)),µ.isValue(d)&&(i=w.gradient(d,I))}}t[n+1]=t[n]=r||V,a.set(e,n,i).set(e+1,n,i).set(e,n+1,i).set(e+1,n+1,i)}g[e+1]=g[e]=t}if(!e||!t)return null;var a=r(e),o=t.primaryGrid,i=t.overlayGrid;W.time("interpolating field");var c=when.defer(),d=this.cancel,u=e.projection,f=e.bounds(U),v=f.height*o.particles.velocityScale,g=[],h=[],m=f.x,p=o.interpolate,y=i.interpolate,b=o!==i,w=i.scale;return J.status(""),function e(){try{if(!d.requested)for(var t=Date.now();m<f.xMax;)if(n(m),m+=2,Date.now()-t>D)return J.progress((m-f.x)/(f.xMax-f.x)),void setTimeout(e,j);c.resolve(l(g,f,a))}catch(e){c.reject(e)}J.progress(1),W.timeEnd("interpolating field")}(),c.promise}function d(e,t,n){function a(){s.forEach(function(e){e.length=0}),u.forEach(function(e){e.age>q&&(t.randomize(e).age=0);var n=e.x,a=e.y,o=t(n,a),i=o[2];if(null===i)e.age=q;else{var r=n+o[0],c=a+o[1];t.isDefined(r,c)?(e.xt=r,e.yt=c,s[l.indexFor(i)].push(e)):(e.x=r,e.y=c)}e.age+=1})}function o(){var e=v.globalCompositeOperation;v.globalCompositeOperation="destination-in",v.fillRect(r.x,r.y,r.width,r.height),v.globalCompositeOperation=e,s.forEach(function(e,t){e.length>0&&(v.beginPath(),v.strokeStyle=l[t],e.forEach(function(e){v.moveTo(e.x,e.y),v.lineTo(e.xt,e.yt),e.x=e.xt,e.y=e.yt}),v.stroke())})}if(e&&t&&n){console.trace("animate");var i=this.cancel,r=e.bounds(U),l=µ.windIntensityColorScale(z,n.primaryGrid.particles.maxIntensity),s=l.map(function(){return[]}),c=Math.round(r.width*N);µ.isMobile()&&(c*=P);var d=µ.isFF()?"rgba(0, 0, 0, 0.95)":"rgba(0, 0, 0, 0.97)";W.debug("particle count: "+c);for(var u=[],f=0;f<c;f++)u.push(t.randomize({age:_.random(0,q)}));var v=d3.select("#animation").node().getContext("2d");v.lineWidth=A,v.fillStyle=d,function e(){try{if(i.requested)return void t.release();a(),o(),setTimeout(e,L)}catch(e){J.error(e)}}()}}function u(e,t,n){if(t&&n&&K.get("showGridPoints")){e.fillStyle="rgba(255, 255, 255, 1)";var a=n.projection.stream({point:function(t,n){e.fillRect(Math.round(t),Math.round(n),1,1)}});t.forEachPoint(function(e,t,n){µ.isValue(n)&&a.point(e,t)})}}function f(e,t){if(e){var n=d3.select("#overlay").node().getContext("2d"),a=(Z.value()||{}).overlayGrid;if(µ.clearCanvas(d3.select("#overlay").node()),µ.clearCanvas(d3.select("#scale").node()),t&&("off"!==t&&n.putImageData(e.overlay,0,0),u(n,a,Y.value())),a){for(var o=d3.select("#scale"),i=a.scale,r=i.bounds,l=o.node(),s=l.getContext("2d"),c=l.width-1,d=0;d<=c;d++){var f=i.gradient(µ.spread(d/c,r[0],r[1]),1);s.fillStyle="rgb("+f[0]+","+f[1]+","+f[2]+")",s.fillRect(d,0,1,l.height)}o.on("mousemove",function(){var e=d3.mouse(this)[0],t=µ.clamp((Math.round(e)-2)/(c-2),0,1),n=µ.spread(t,r[0],r[1]),i="wind"===a.type?"#location-wind-units":"#location-value-units",l=m(i,a).value();o.attr("title",µ.formatScalar(n,l)+" "+l.label)})}}}function v(e){var t=3*C,n=e?e.primaryGrid.date.getTime():Math.floor(Date.now()/t)*t,a=K.get("date").split("/"),o=K.get("hour");return a.length>1?Date.UTC(+a[0],a[1]-1,+a[2],+o.substring(0,2)):"current"===a[0]?n:null}function g(e){var t=new Date(v(e)),n=d3.select("#data-date").classed("local"),a=n?µ.toLocalISO(t):µ.toUTCISO(t);d3.select("#data-date").text(a+" "+(n?"Local":"UTC")),d3.select("#toggle-zone").text("⇄ "+(n?"UTC":"Local"))}function h(e){g(e);var t="",n="";if(e){var a=d3.select("body").attr("data-lang")||"en",o=e.primaryGrid.description(a),i=e.overlayGrid.description(a);t=i.name+i.qualifier,e.primaryGrid!==e.overlayGrid&&(t=(o.qualifier===i.qualifier?o.name:o.name+o.qualifier)+" + "+t),n=e.overlayGrid.source}d3.select("#data-layer").text(t),d3.select("#data-center").text(n)}function m(e,t){var n=t.units,a=n.length,o=+(d3.select(e).attr("data-index")||0)%a;return{value:function(){return n[o]},next:function(){d3.select(e).attr("data-index",o=(o+1)%a)}}}function p(e,t){var n=m("#location-wind-units",t),a=n.value();d3.select("#location-wind").text(µ.formatVector(e,a)),d3.select("#location-wind-units").text(a.label).on("click",function(){n.next(),p(e,t)})}function y(e,t){var n=m("#location-value-units",t),a=n.value();d3.select("#location-value").text(µ.formatScalar(e,a)),d3.select("#location-value-units").text(a.label).on("click",function(){n.next(),y(e,t)})}function b(e,t){e=e||[],t=t||[];var n=Z.value(),a=ee.value(),o=t[0],i=t[1];if(a&&a.isInsideBoundary(e[0],e[1])&&(k(!1),oe={point:e,coord:t},_.isFinite(o)&&_.isFinite(i)&&(d3.select("#location-coord").text(µ.formatCoordinates(o,i)),d3.select("#location-close").classed("invisible",!1)),a.isDefined(e[0],e[1])&&n)){var r=n.primaryGrid.interpolate(o,i);if(µ.isValue(r)&&p(r,n.primaryGrid),n.overlayGrid!==n.primaryGrid){var l=n.overlayGrid.interpolate(o,i);µ.isValue(l)&&y(l,n.overlayGrid)}}}function w(){b(oe.point,oe.coord)}function k(e){d3.select("#location-coord").text(""),d3.select("#location-close").classed("invisible",!0),d3.select("#location-wind").text(""),d3.select("#location-wind-units").text(""),d3.select("#location-value").text(""),d3.select("#location-value-units").text(""),e&&(oe={},d3.select(".location-mark").remove())}function x(e){te.cancel(),e&&µ.clearCanvas(d3.select("#animation").node())}function T(e,t,n){n=n||_.keys(t),d3.select(e).on("click",function(){d3.select(e).classed("disabled")||K.save(t)}),K.on("change",function(a){var o=a.attributes;d3.select(e).classed("highlighted",_.isEqual(_.pick(o,n),_.pick(t,n)))})}function M(e){ga&&ga("send","event","sponsor",e)}function G(){function e(){$.submit(i,X.value(),Y.value())}function r(){ee.submit(c,Y.value(),Z.value())}function l(){ee.cancel()}J.status("Initializing..."),d3.select("#sponsor-link").attr("target",µ.isEmbeddedInIFrame()?"_new":null).on("click",M.bind(null,"click")).on("contextmenu",M.bind(null,"right-click")),d3.select("#sponsor-hide").on("click",function(){d3.select("#sponsor").classed("invisible",!0)}),d3.selectAll(".fill-screen").attr("width",U.width).attr("height",U.height);var s=d3.select("#scale-label").node();d3.select("#scale").attr("width",.97*(d3.select("#menu").node().offsetWidth-s.offsetWidth)).attr("height",s.offsetHeight/2),d3.select("#show-menu").on("click",function(){µ.isEmbeddedInIFrame()?window.open("http://earth.nullschool.net/"+window.location.hash,"_blank"):d3.select("#menu").classed("invisible",!d3.select("#menu").classed("invisible"))}),µ.isFF()&&d3.select("#display").classed("firefox",!0),"ontouchstart"in document.documentElement?d3.select(document).on("touchstart",function(){}):d3.select(document.documentElement).classed("no-touch",!0),d3.select(window).on("hashchange",function(){W.debug("hashchange"),K.fetch({trigger:"hashchange"})}),K.on("change",J.reset),X.listenTo(K,"change:topology",function(e,n){X.submit(t,n)}),Y.listenTo(K,"change:projection",function(e,t){Y.submit(n,t)}),Z.listenTo(K,"change",function(){var e=_.keys(K.changedAttributes()),t=!1;_.intersection(e,["date","hour","param","surface","level"]).length>0&&(t=!0);var n=K.get("overlayType")||"default";if(_.indexOf(e,"overlayType")>=0&&"off"!==n){var o=Z.value()||{},i=o.primaryGrid,r=o.overlayGrid;r?r.type===n||"default"===n&&i===r||(t=!0):t=!0}t&&Z.submit(a)}),Z.on("submit",function(){h(null)}),Z.on("update",function(e){h(e)}),d3.select("#toggle-zone").on("click",function(){d3.select("#data-date").classed("local",!d3.select("#data-date").classed("local")),g(Z.cancel.requested?null:Z.value())}),$.listenTo(X,"update",e),$.listenTo(Y,"update",e),ee.listenTo(Z,"update",r),ee.listenTo($,"render",r),ee.listenTo($,"start",l),ee.listenTo($,"redraw",l),te.listenTo(ee,"update",function(e){te.submit(d,Y.value(),e,Z.value())}),te.listenTo($,"start",x.bind(null,!0)),te.listenTo(Z,"submit",x.bind(null,!1)),te.listenTo(ee,"submit",x.bind(null,!1)),ne.listenTo(ee,"update",function(){ne.submit(f,ee.value(),K.get("overlayType"))}),ne.listenTo($,"start",function(){ne.submit(f,ee.value(),null)}),ne.listenTo(K,"change",function(){var e=_.keys(K.changedAttributes());_.intersection(e,["overlayType","showGridPoints"]).length>0&&ne.submit(f,ee.value(),K.get("overlayType"))}),Q.on("click",b),ee.on("update",w),d3.select("#location-close").on("click",_.partial(k,!0)),K.on("change:param",function(e,t){switch(d3.selectAll(".ocean-mode").classed("invisible","ocean"!==t),d3.selectAll(".wind-mode").classed("invisible","wind"!==t),t){case"wind":d3.select("#nav-backward-more").attr("title","-1 Day"),d3.select("#nav-backward").attr("title","-3 Hours"),d3.select("#nav-forward").attr("title","+3 Hours"),d3.select("#nav-forward-more").attr("title","+1 Day");break;case"ocean":d3.select("#nav-backward-more").attr("title","-1 Month"),d3.select("#nav-backward").attr("title","-5 Days"),d3.select("#nav-forward").attr("title","+5 Days"),d3.select("#nav-forward-more").attr("title","+1 Month")}}),d3.select("#wind-mode-enable").on("click",function(){"wind"!==K.get("param")&&K.save({param:"wind",surface:"surface",level:"level",overlayType:"default"})}),K.on("change:param",function(e,t){d3.select("#wind-mode-enable").classed("highlighted","wind"===t)}),d3.select("#ocean-mode-enable").on("click",function(){if("ocean"!==K.get("param")){var e={param:"ocean",surface:"surface",level:"currents",overlayType:"default"},t=_.clone(K.attributes);"current"===t.date?K.save(e):when.all(products.productsFor(_.extend(t,e))).spread(function(t){t.date&&K.save(_.extend(e,µ.dateToConfig(t.date)))}).otherwise(J.error),x(!0)}}),K.on("change:param",function(e,t){d3.select("#ocean-mode-enable").classed("highlighted","ocean"===t)}),K.on("change:overlayType",function(e,t){d3.select("#surface-level").classed("disabled","air_density"===t||"wind_power_density"===t)}),K.on("change:surface",function(e,t){d3.select("#overlay-air_density").classed("disabled","surface"===t),d3.select("#overlay-wind_power_density").classed("disabled","surface"===t)}),d3.select("#nav-backward-more").on("click",o.bind(null,-10)),d3.select("#nav-forward-more").on("click",o.bind(null,10)),d3.select("#nav-backward").on("click",o.bind(null,-1)),d3.select("#nav-forward").on("click",o.bind(null,1)),d3.select("#nav-now").on("click",function(){K.save({date:"current",hour:""})}),d3.select("#option-show-grid").on("click",function(){K.save({showGridPoints:!K.get("showGridPoints")})}),K.on("change:showGridPoints",function(e,t){d3.select("#option-show-grid").classed("highlighted",t)}),d3.selectAll(".surface").each(function(){var e=this.id,t=e.split("-");T("#"+e,{param:"wind",surface:t[0],level:t[1]})}),T("#animate-currents",{param:"ocean",surface:"surface",level:"currents"}),products.overlayTypes.forEach(function(e){T("#overlay-"+e,{overlayType:e})}),T("#overlay-wind",{param:"wind",overlayType:"default"}),T("#overlay-ocean-off",{overlayType:"off"}),T("#overlay-currents",{overlayType:"default"}),globes.keys().forEach(function(e){T("#"+e,{projection:e,orientation:""},["projection"])}),d3.select(window).on("orientationchange",function(){U=µ.view(),Y.submit(n,K.get("projection"))})}function E(){K.fetch()}var C=36e5,D=100,j=25,S=4,F=1e3,I=Math.floor(102),z=10,q=100,A=1,N=7,P=.75,L=40,H=[NaN,NaN,null],V=[NaN,NaN,null],O=[0,0,0,0],B="▫▫▫▫▫▫▫▫▫▫▫▫▫▫▫▫▫▫▫▫▫▫",R="▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪",U=µ.view(),W=µ.log(),J=function(){var e=d3.select("#status"),t=d3.select("#progress"),n=B.length;return{status:function(t){return e.classed("bad")?e:e.text(t)},error:function(t){var n=t.status?t.status+" "+t.message:t;switch(t.status){case-1:n="Server Down";break;case 404:n="No Data"}return W.error(t),e.classed("bad",!0).text(n)},reset:function(){return e.classed("bad",!1).text("")},progress:function(e){if(0<=e&&e<1){var a=Math.ceil(e*n),o=R.substr(0,a)+B.substr(0,n-a);return t.classed("invisible",!1).text(o)}return t.classed("invisible",!0).text("")}}}(),K=µ.buildConfiguration(globes,products.overlayTypes),Q=function(){function e(e,t){return{type:"click",startMouse:e,startScale:t,manipulator:n.manipulator(e,t)}}function t(){var e=arguments[3]||{};n&&"moveEnd"!==e.source&&(r.trigger("moveStart"),n.orientation(K.get("orientation"),U),o.scale(n.projection.scale()),r.trigger("moveEnd"))}var n,a=null,o=d3.behavior.zoom().on("zoomstart",function(){a=a||e(d3.mouse(this),o.scale())}).on("zoom",function(){var t=d3.mouse(this),n=d3.event.scale;if(a=a||e(t,1),"click"===a.type||"spurious"===a.type){var o=µ.distance(t,a.startMouse);if(n===a.startScale&&o<S)return void(a.type=o>0?"click":"spurious");r.trigger("moveStart"),a.type="drag"}n!=a.startScale&&(a.type="zoom"),a.manipulator.move("zoom"===a.type?null:t,n),r.trigger("move")}).on("zoomend",function(){a.manipulator.end(),"click"===a.type?r.trigger("click",a.startMouse,n.projection.invert(a.startMouse)||[]):"spurious"!==a.type&&i(),a=null}),i=_.debounce(function(){(!a||"drag"!==a.type&&"zoom"!==a.type)&&(K.save({orientation:n.orientation()},{source:"moveEnd"}),r.trigger("moveEnd"))},F);d3.select("#display").call(o),d3.select("#show-location").on("click",function(){navigator.geolocation&&(J.status("Finding current position..."),navigator.geolocation.getCurrentPosition(function(e){J.status("");var t=[e.coords.longitude,e.coords.latitude],a=n.locate(t);a&&(n.projection.rotate(a),K.save({orientation:n.orientation()})),r.trigger("click",n.projection(t),t)},W.error))});var r=_.extend({globe:function(e){return e&&(n=e,o.scaleExtent(n.scaleExtent()),t()),e?this:n}},Backbone.Events);return r.listenTo(K,"change:orientation",t)}(),X=e(),Y=e(),Z=e(),$=e(),ee=e(),te=e(),ne=e(),ae=0,oe={};when(!0).then(G).then(E).otherwise(J.error)}();